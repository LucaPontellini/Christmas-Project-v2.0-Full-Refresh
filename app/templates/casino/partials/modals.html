<link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">

{% set flashed_messages = get_flashed_messages(with_categories=true) %}

<div class="modal" id="loginModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Welcome Back</h2>

        {% for category, message in flashed_messages %}
            {% if category == "login_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <div class="spid-notice">
            <strong>⚠️ SPID LOGIN UNDER DEVELOPMENT</strong>
            <span>The system is undergoing AGID certification. Please use standard login.</span>
        </div>

        <form method="POST" action="/account/login">
            <input type="hidden" name="auth_method" value="standard">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn primary">Login Now</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('forgot')">Forgot password?</span>
            <p style="font-size:13px;color:var(--text-muted);margin-top:12px;">
                Don’t have an account? <span class="link-text" onclick="openModal('register')">Sign up</span>
            </p>
        </div>
    </div>
</div>

<div class="modal" id="registerModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Create Account</h2>
        <p class="subtitle">Join our community today.</p>

        {% for category, message in flashed_messages %}
            {% if category == "register_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <form method="POST" action="/account/register">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Choose Username" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn primary">Register</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Already have an account?</span>
        </div>
    </div>
</div>

<div class="modal" id="forgotModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Recovery</h2>
        <p class="subtitle">Enter your username to generate a recovery PIN.</p>

        {% for category, message in flashed_messages %}
            {% if category == "forgot_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <form method="POST" action="/account/forgot-pin">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Your Username" required>
            </div>
            <button type="submit" class="btn primary">Generate PIN</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Back to Login</span>
        </div>
    </div>
</div>

<div class="modal" id="recoveryCompleteModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Reset Password</h2>

        {% if not session.get('reset_username') %}
            <div class="form-error">Invalid session. Please request a new PIN.</div>
        {% endif %}

        {% for category, message in flashed_messages %}
            {% if category == "reset_error" %}
                <div class="form-error">{{ message }}</div>
            {% endif %}
            {% if category == "reset_pin" %}
                <div class="pin-box">YOUR NEW PIN: <strong>{{ message }}</strong></div>
            {% endif %}
        {% endfor %}

        <form method="POST" action="/account/reset-password">
            <input type="hidden" name="username" value="{{ session.get('reset_username', '') }}">

            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/852/852289.png" class="input-icon-left" alt="PIN">
                <input type="text" name="pin" placeholder="6-digit Recovery PIN" maxlength="6" pattern="\d{6}" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" id="new_password" name="password" placeholder="New Password" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" id="confirm_password" placeholder="Confirm New Password" required>
            </div>

            <div class="password-requirements">
                <div class="requirement" id="req-length">At least 6 characters</div>
                <div class="requirement" id="req-upper">At least one uppercase letter</div>
                <div class="requirement" id="req-num">At least one number</div>
                <div class="requirement" id="req-match">Passwords match</div>
            </div>

            <button type="submit" class="btn primary">Update Password</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Back to Login</span>
        </div>
    </div>
</div>

<div class="modal" id="deleteAccountModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Delete Account</h2>
        <p class="subtitle">This action is irreversible.<br>All your data will be permanently disabled.</p>

        <form method="POST" action="{{ url_for('account.delete_account') }}">
            <button type="submit" class="btn primary" style="background:#dc2626;color:#fff;">Yes, delete my account</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="closeAll()">Cancel</span>
        </div>
    </div>
</div>

<script>
    window.FLASH_TARGET_MODAL = null;
    {% for category, message in flashed_messages %}
        {% if category in ['reset_pin', 'reset_error'] %}
            window.FLASH_TARGET_MODAL = 'recoveryComplete';
        {% elif category == 'login_error' %}
            window.FLASH_TARGET_MODAL = 'login';
        {% elif category == 'register_error' %}
            window.FLASH_TARGET_MODAL = 'register';
        {% elif category == 'forgot_error' %}
            window.FLASH_TARGET_MODAL = 'forgot';
        {% endif %}
    {% endfor %}
</script>

<script src="{{ url_for('static', filename='js/modals.js') }}"></script>