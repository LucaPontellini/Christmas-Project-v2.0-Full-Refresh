{% set flashed_messages = get_flashed_messages(with_categories=true) %}

<!-- STILI IN CIMA (OBBLIGATORIO PER VISIBILITÀ CORRETTA) -->
<style>
    :root {
        --primary-gold: #f5c400;
        --bg-dark-gradient: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
        --glass-white: rgba(255, 255, 255, 0.05);
        --border-color: rgba(255, 255, 255, 0.1);
        --text-muted: #a0a0a0;
        --icon-glow: drop-shadow(0 0 5px rgba(245, 196, 0, 0.7));
        --error-color: #ff4747;
        --success-color: #47ff8c;
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: all 0.4s cubic-bezier(0.16,1,0.3,1);
        z-index: 1000;
    }
    .modal.show { opacity: 1; pointer-events: auto; }

    .modal-content {
        background: var(--bg-dark-gradient);
        border: 1px solid var(--border-color);
        border-radius: 28px;
        padding: 40px 30px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        position: relative;
        text-align: center;
    }

    h2 { margin-bottom: 8px; font-size: 24px; color: #fff; font-weight: 700; }
    p.subtitle { margin-bottom: 20px; color: var(--text-muted); font-size: 14px; }

    .spid-notice {
        background: rgba(245, 196, 0, 0.08);
        border: 1px solid rgba(245, 196, 0, 0.3);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
    }
    .spid-notice strong { color: var(--primary-gold); display: block; margin-bottom: 4px; font-size: 13px; }
    .spid-notice span { font-size: 11px; color: #eee; line-height: 1.3; display: block; }

    .input-group { position: relative; width: 100%; margin-bottom: 15px; }
    .input-icon-left { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 18px; filter: var(--icon-glow); z-index: 2; }
    input {
        width: 100%;
        background: var(--glass-white);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px 15px 15px 45px;
        color: #fff;
        font-size: 15px;
        box-sizing: border-box;
        transition: 0.3s;
    }
    input:focus { outline: none; border-color: var(--primary-gold); background: rgba(255,255,255,0.1); }

    .pin-box {
        background: var(--primary-gold);
        color: #000;
        padding: 16px 20px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        text-align: center;
        margin: 15px 0;
        box-shadow: 0 4px 12px rgba(245, 196, 0, 0.4);
    }

    .password-requirements { text-align: left; margin: 10px 0 20px 5px; font-size: 12px; color: var(--text-muted); }
    .requirement { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; transition: 0.3s; }
    .requirement::before { content: "✕"; color: var(--error-color); }
    .requirement.valid::before { content: "✓"; color: var(--success-color); }

    .btn {
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .btn.primary { background: var(--primary-gold); color: #000; margin-top: 10px; }
    .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 196, 0, 0.3); }

    .modal-footer { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
    .link-text { color: var(--primary-gold); cursor: pointer; font-weight: 600; text-decoration: none; font-size: 13px; }

    .close-modal { position: absolute; top: 15px; right: 20px; background: none; border: none;
                   color: var(--text-muted); font-size: 24px; cursor: pointer; }

    .form-error {
        background: linear-gradient(135deg, rgba(255, 71, 71, 0.18), rgba(255, 71, 71, 0.08));
        border: 1px solid rgba(255, 71, 71, 0.6);
        color: #ffb3b3;
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        margin: 12px 0 18px 0;
        text-align: center;
        box-shadow: 0 0 15px rgba(255, 71, 71, 0.25);
    }
</style>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Welcome Back</h2>

        {% for category, message in flashed_messages %}
            {% if category == "login_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <div class="spid-notice">
            <strong>⚠️ SPID LOGIN UNDER DEVELOPMENT</strong>
            <span>The system is undergoing AGID certification. Please use standard login.</span>
        </div>

        <form method="POST" action="/account/login">
            <input type="hidden" name="auth_method" value="standard">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn primary">Login Now</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('forgot')">Forgot password?</span>
            <p style="font-size:13px;color:var(--text-muted);margin-top:12px;">
                Don’t have an account? <span class="link-text" onclick="openModal('register')">Sign up</span>
            </p>
        </div>
    </div>
</div>

<!-- REGISTER MODAL -->
<div class="modal" id="registerModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Create Account</h2>
        <p class="subtitle">Join our community today.</p>

        {% for category, message in flashed_messages %}
            {% if category == "register_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <form method="POST" action="/account/register">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Choose Username" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn primary">Register</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Already have an account?</span>
        </div>
    </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div class="modal" id="forgotModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Recovery</h2>
        <p class="subtitle">Enter your username to generate a recovery PIN.</p>

        {% for category, message in flashed_messages %}
            {% if category == "forgot_error" %}<div class="form-error">{{ message }}</div>{% endif %}
        {% endfor %}

        <form method="POST" action="/account/forgot-pin">
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="input-icon-left" alt="User">
                <input type="text" name="username" placeholder="Your Username" required>
            </div>
            <button type="submit" class="btn primary">Generate PIN</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Back to Login</span>
        </div>
    </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="modal" id="recoveryCompleteModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Reset Password</h2>

        {% if not session.get('reset_username') %}
            <div class="form-error">Invalid session. Please request a new PIN.</div>
        {% endif %}

        {% for category, message in flashed_messages %}
            {% if category == "reset_error" %}
                <div class="form-error">{{ message }}</div>
            {% endif %}
            {% if category == "reset_pin" %}
                <div class="pin-box">YOUR NEW PIN: <strong>{{ message }}</strong></div>
            {% endif %}
        {% endfor %}

        <form method="POST" action="/account/reset-password">
            <input type="hidden" name="username" value="{{ session.get('reset_username', '') }}">

            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/852/852289.png" class="input-icon-left" alt="PIN">
                <input type="text" name="pin" placeholder="6-digit Recovery PIN" maxlength="6" pattern="\d{6}" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" id="new_password" name="password" placeholder="New Password" required>
            </div>
            <div class="input-group">
                <img src="https://cdn-icons-png.flaticon.com/512/3064/3064155.png" class="input-icon-left" alt="Lock">
                <input type="password" id="confirm_password" placeholder="Confirm New Password" required>
            </div>

            <div class="password-requirements">
                <div class="requirement" id="req-length">At least 6 characters</div>
                <div class="requirement" id="req-upper">At least one uppercase letter</div>
                <div class="requirement" id="req-num">At least one number</div>
                <div class="requirement" id="req-match">Passwords match</div>
            </div>

            <button type="submit" class="btn primary">Update Password</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="openModal('login')">Back to Login</span>
        </div>
    </div>
</div>

<!-- DELETE ACCOUNT MODAL -->
<div class="modal" id="deleteAccountModal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAll()">&times;</button>
        <h2>Delete Account</h2>
        <p class="subtitle">This action is irreversible.<br>All your data will be permanently disabled.</p>

        <form method="POST" action="{{ url_for('account.delete_account') }}">
            <button type="submit" class="btn primary" style="background:#dc2626;color:#fff;">Yes, delete my account</button>
        </form>

        <div class="modal-footer">
            <span class="link-text" onclick="closeAll()">Cancel</span>
        </div>
    </div>
</div>

<!-- SCRIPT -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Mappatura dei Modal
        const modals = {
            login: document.getElementById('loginModal'),
            register: document.getElementById('registerModal'),
            forgot: document.getElementById('forgotModal'),
            recoveryComplete: document.getElementById('recoveryCompleteModal'),
            deleteAccount: document.getElementById('deleteAccountModal')
        };

        // 2. Funzioni di Controllo (Globali per essere usate negli onclick HTML)
        window.closeAll = function() {
            Object.values(modals).forEach(m => m?.classList.remove('show'));
        };

        window.openModal = function(type) {
            closeAll();
            
            setTimeout(() => {
                const modal = modals[type];
                if (!modal) return;

                modal.classList.add('show');

                // Focus automatico sul PIN se presente
                const pinInput = modal.querySelector('input[name="pin"]');
                if (pinInput) pinInput.focus();

                // Sincronizzazione Username tra Forgot e Recovery (Fallback JS)
                if (type === 'recoveryComplete') {
                    const usernameInput = modal.querySelector('input[name="username"]');
                    const forgotUsername = document.querySelector('#forgotModal input[name="username"]')?.value;
                    if (usernameInput && forgotUsername && !usernameInput.value) {
                        usernameInput.value = forgotUsername;
                    }
                }
            }, 80);
        };

        // 3. Chiusura al click fuori dal modal
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) closeAll();
        };

        // 4. LOGICA AUTO-APERTURA (Basata sui Flash Messages di Flask)
        let targetModal = null;
        
        // Usiamo la variabile 'flashed_messages' definita in cima al file Jinja
        {% for category, message in flashed_messages %}
            {% if category in ['reset_pin', 'reset_error'] %}
                targetModal = 'recoveryComplete';
            {% elif category == 'login_error' and not targetModal %}
                targetModal = 'login';
            {% elif category == 'register_error' and not targetModal %}
                targetModal = 'register';
            {% elif category == 'forgot_error' and not targetModal %}
                targetModal = 'forgot';
            {% endif %}
        {% endfor %}

        if (targetModal) openModal(targetModal);

        // 5. VALIDAZIONE PASSWORD LIVE
        const newPass = document.getElementById('new_password');
        const confirmPass = document.getElementById('confirm_password');

        if (newPass && confirmPass) {
            const updateRules = () => {
                const p = newPass.value;
                const c = confirmPass.value;

                // Aggiornamento classi CSS per i requisiti
                document.getElementById('req-length').classList.toggle('valid', p.length >= 6);
                document.getElementById('req-upper').classList.toggle('valid', /[A-Z]/.test(p));
                document.getElementById('req-num').classList.toggle('valid', /\d/.test(p));
                document.getElementById('req-match').classList.toggle('valid', p === c && p !== "");
            };

            newPass.addEventListener('input', updateRules);
            confirmPass.addEventListener('input', updateRules);
        }
    });
</script>