{% extends "base.html" %}
{% block content %}

<style>
    :root {
        --admin-bg: #0a0a0a;
        --card-dark: #1a1a1a; 
        --accent-gold: #c5a000; 
        --text-muted: #a0a0a0; 
        --text-light: #f0f0f0; 
        --border: rgba(255, 255, 255, 0.08);
        --danger-red: #ff5252;
        --success-green: #4ade80;
        --info-blue: #3b82f6;
    }

    body { background: var(--admin-bg); overflow-x: hidden; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; color: var(--text-light); margin: 0; }

    /* SIDEBAR */
    .sidebar {
        width: 260px; background: #0f172a; color: #fff; padding: 20px;
        box-sizing: border-box; position: fixed; top: 0; left: 0;
        min-height: 100vh; height: 100vh; overflow-y: auto; z-index: 1000;
        border-right: 1px solid var(--border);
    }
    .sidebar h2 { text-align: center; margin-bottom: 24px; font-size: 20px; color: var(--accent-gold); font-weight: 800; }
    
    .user-profile { text-align: center; margin-bottom: 20px; }
    
    .user-avatar {
        width: 110px; height: 110px; border-radius: 50% !important; margin: 0 auto 15px;
        display: flex; align-items: center; justify-content: center;
        background: #1e293b; overflow: hidden !important; 
        border: 2px solid var(--accent-gold);
        box-shadow: 0 0 15px rgba(197, 160, 0, 0.3);
    }
    .admin-photo-bg { background-size: cover; background-position: center; }

    .btn { display: block; width: 100%; margin: 6px 0; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; text-align: center; font-size: 13px; transition: 0.2s; text-decoration: none; }
    .btn.logout { background: #334155; color: #fff; }
    .btn.logout:hover { background: #475569; }
    .admin-badge { display: inline-block; margin-top: 8px; padding: 4px 12px; font-size: 11px; background: var(--accent-gold); color: #000; border-radius: 4px; font-weight: 800; }
    
    /* MENU */
    ul { list-style: none; padding: 0; margin-top: 20px; }
    ul li { margin: 8px 0; }
    ul li a { color: #ffffff; text-decoration: none; font-size: 14px; transition: 0.2s; display: block; padding: 10px 12px; border-radius: 6px; }
    ul li a:hover { color: var(--accent-gold); background: rgba(197, 160, 0, 0.15); }
    ul li a.active { background: rgba(197, 160, 0, 0.25); color: var(--accent-gold); font-weight: bold; }
    .menu-group { margin: 28px 0 8px; font-size: 11px; text-transform: uppercase; color: var(--accent-gold); opacity: 0.8; letter-spacing: 1px; font-weight: 700; }

    /* CONTENT AREA */
    .admin-main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; min-height: 100vh; box-sizing: border-box; }
    .header-flex { margin-bottom: 30px; border-bottom: 2px solid var(--accent-gold); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .header-flex h1 { font-size: 28px; font-weight: 800; color: #fff; margin: 0; }

    /* STATS CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background: #151515; border-radius: 12px; border: 1px solid var(--border); }
    .stat-card { background: var(--card-dark); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .stat-card h3 { font-size: 11px; text-transform: uppercase; color: var(--accent-gold); margin-bottom: 10px; font-weight: 700; }
    .stat-card .value { font-size: 24px; font-weight: 800; color: #fff; }

    /* SECTIONS */
    .section-box { background: #151515; border-radius: 12px; padding: 25px; border: 1px solid var(--border); margin-bottom: 30px; }
    .section-title { font-size: 15px; margin-bottom: 20px; color: var(--accent-gold); font-weight: 800; text-transform: uppercase; border-left: 4px solid var(--accent-gold); padding-left: 15px; }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; background: #1a1a1a; border-radius: 8px; overflow: hidden; }
    th { background: #252525; text-align: left; padding: 12px; font-size: 11px; color: #fff; text-transform: uppercase; }
    td { padding: 12px; border-bottom: 1px solid #252525; font-size: 13px; color: #e0e0e0; vertical-align: middle; }

    .btn-small { padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 800; border: none; cursor: pointer; transition: 0.2s; }
    .btn-add { background: #16a34a; color: #fff; }
    .btn-sub { background: #b91c1c; color: #fff; }
    .btn-small:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }

    .status-tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
    .status-active { background: #064e3b; color: #4ade80; }
    .status-deleted { background: #7f1d1d; color: #fca5a5; }

    .highlight-glow { box-shadow: 0 0 30px rgba(197, 160, 0, 0.7) !important; transition: box-shadow 0.5s ease; }

    /* BALANCE FORM */
    .add-balance-form { display: flex; gap: 4px; align-items: center; }
    .add-balance-form input[name="amount"] { width: 70px; background: #000; border: 1px solid var(--border); border-radius: 4px; padding: 6px; color: var(--accent-gold); font-weight: bold; outline: none; }

    /* MODAL DESIGN */
    #hard-delete-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: #1a1a1a;
        padding: 30px;
        border-radius: 12px;
        border: 1px solid var(--danger-red);
        max-width: 400px;
        text-align: center;
    }

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-20px); }
        10% { opacity: 1; transform: translateY(0); }
        90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    .flash-success, .flash-error { animation: fadeInOut 5s ease forwards; }
</style>

<aside class="sidebar">
    <h2>Ponte's Casino</h2>
    <div class="user-profile">
        {% if user and user.role == "admin" %}
            <div class="user-avatar admin-photo-bg" style="background-image: url('{{ url_for('static', filename='images/Luca_Pontellini.jpg') }}');"></div>
        {% else %}
            <div class="user-avatar"><img src="{{ url_for('static', filename='images/user_icon.png') }}" alt="User"></div>
        {% endif %}
        {% if user %}
            <a href="{{ url_for('account.logout') }}" class="btn logout">Logout</a>
            <div class="admin-badge">ADMIN</div>
        {% endif %}
    </div>
    <ul>
        <li><a href="{{ url_for('casino.lobby') }}">Back to Casino</a></li>
        <li class="menu-group">Dashboard</li>
        <li><a href="#stats-grid" class="menu-link active" data-target="stats-grid">Global Stats</a></li>
        <li><a href="#account-management" class="menu-link" data-target="account-management">Account Management</a></li>
        <li><a href="#cash-flow" class="menu-link" data-target="cash-flow">Recent Cash Flow</a></li>
        <li><a href="#system-activity" class="menu-link" data-target="system-activity">System Activity</a></li>
    </ul>
</aside>

<div class="admin-main">
    <div class="header-flex">
        <h1>Global Dashboard</h1>
        <div style="font-size: 12px; color: var(--text-muted);">
            Server Status: <span style="color: var(--success-green); font-weight: bold;">● ONLINE</span>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-{{ category }}" style="padding: 12px; margin-bottom: 20px; border-radius: 8px; background: {% if category == 'success' %}#064e3b{% else %}#7f1d1d{% endif %}; color: white; font-size: 13px; font-weight: 600;">
            {{ "✓" if category == 'success' else "⚠" }} {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div id="stats-grid" class="stats-grid">
        <div class="stat-card"><h3>Total Users</h3><span class="value">{{ stats.users }}</span></div>
        <div class="stat-card"><h3>Chips Volume</h3><span class="value">€{{ stats.total_chips_value or '0' }}</span></div>
        <div class="stat-card"><h3>GGR (Net Revenue)</h3><span class="value" style="color: var(--success-green);">€{{ stats.revenue or '0' }}</span></div>
        <div class="stat-card"><h3>Bonuses Issued</h3><span class="value" style="color: var(--danger-red);">€{{ stats.total_bonuses or '0' }}</span></div>
    </div>

    <div id="account-management" class="section-box">
        <h2 class="section-title">Account Management</h2>
        <table>
            <thead>
                <tr><th>Username</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody>
                {% for u in users %}
                    <tr>
                        <td>{{ u.username }}</td>
                        <td style="font-weight: bold; color: var(--accent-gold);">€ {{ u.balance }}</td>
                        <td><span class="status-tag {{ 'status-deleted' if u.is_deleted else 'status-active' }}">{{ 'Disabled' if u.is_deleted else 'Active' }}</span></td>
                        <td>
                            <div style="display:flex; gap:10px; align-items:center;">
                                {% if u.id != user.id and u.role != "admin" and not u.is_deleted %}
                                    <form action="{{ url_for('admin.add_balance', user_id=u.id) }}" method="POST" class="add-balance-form">
                                        <input type="number" name="amount" placeholder="0">
                                        <button name="action" value="add" class="btn-small btn-add" disabled>+</button>
                                        <button name="action" value="sub" class="btn-small btn-sub" disabled>-</button>
                                    </form>
                                {% endif %}

                                {% if u.id != user.id %}
                                    {% if not u.is_deleted %}
                                        <form action="{{ url_for('admin.delete_user', user_id=u.id) }}" method="POST">
                                            <button class="btn-small" style="background:#f97316; color:black;">Soft Delete</button>
                                        </form>
                                    {% else %}
                                        <form action="{{ url_for('admin.restore_user_route', user_id=u.id) }}" method="POST" style="display:inline;">
                                            <button class="btn-small" style="background:var(--success-green); color:black;">Restore</button>
                                        </form>
                                        <form action="{{ url_for('admin.hard_delete_user_route', user_id=u.id) }}" method="POST" class="hard-delete-form" style="display:inline;">
                                            <button type="button" class="btn-small btn-hard-delete hard-delete-btn" style="background:var(--danger-red); color:white;" data-username="{{ u.username }}">
                                                Hard Delete
                                            </button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="cash-flow" class="section-box">
        <h2 class="section-title">Recent Cash Flow</h2>
        <table>
            <thead><tr><th>User</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.username }}</td>
                    <td><span class="status-tag" style="background: #333;">{{ t.type }}</span></td>
                    <td style="font-weight: bold; color: {% if t.amount < 0 %}var(--danger-red){% else %}var(--success-green){% endif %};">
                        {% if t.amount > 0 %}+{% endif %} €{{ t.amount }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="system-activity" class="section-box">
        <h2 class="section-title">System Activity</h2>
        <table>
            <thead><tr><th>User</th><th>Action</th><th>Time</th></tr></thead>
            <tbody>
                {% for l in logs %}
                <tr>
                    <td>{{ l.username or "Guest" }}</td>
                    <td><span class="status-tag" style="background:#1e293b; color:#93c5fd;">{{ l.action }}</span></td>
                    <td style="font-size: 10px; color: #777;">{{ l.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="hard-delete-modal">
    <div class="modal-content">
        <h2 style="color:var(--danger-red);">⚠️ PERMANENT DELETE</h2>
        <p>Are you sure you want to permanently delete <strong id="modal-username"></strong>?</p>
        <p style="font-size:12px; color:var(--text-muted);">This action cannot be undone.</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button id="cancel-delete" class="btn-small" style="background:#444; color:white;">Cancel</button>
            <button id="confirm-delete" class="btn-small" style="background:var(--danger-red); color:white;">Confirm Delete</button>
        </div>
    </div>
</div>

<script>
// --- 1. GESTIONE BILANCIO ---
document.querySelectorAll('.add-balance-form').forEach(form => {
    const input = form.querySelector('input[name="amount"]');
    const btnAdd = form.querySelector('.btn-add');
    const btnSub = form.querySelector('.btn-sub');
    
    input.addEventListener('input', () => {
        const val = parseInt(input.value, 10);
        const invalid = isNaN(val) || val <= 0;
        btnAdd.disabled = invalid; 
        btnSub.disabled = invalid;
    });
});

// --- 2. NAVIGAZIONE SIDEBAR ---
document.querySelectorAll('.menu-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        const target = document.getElementById(this.dataset.target);
        if (target) {
            target.classList.add('highlight-glow');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => target.classList.remove('highlight-glow'), 1500);
        }
    });
});

// --- 3. LOGICA MODALE HARD DELETE ---
const modal = document.getElementById('hard-delete-modal');
const modalUser = document.getElementById('modal-username');
let deleteForm = null;

document.querySelectorAll('.hard-delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        modalUser.textContent = this.dataset.username;
        deleteForm = this.closest('form'); 
        modal.style.display = 'flex';
    });
});

document.getElementById('cancel-delete').onclick = () => {
    modal.style.display = 'none';
    deleteForm = null;
};

document.getElementById('confirm-delete').onclick = () => { 
    if(deleteForm) {
        deleteForm.submit(); 
    }
};

window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = 'none';
        deleteForm = null;
    }
};
</script>

{% endblock %}